# Data Model: Authenticated Chat with Session Windows

**Feature**: 010-fastapi-auth-chat-windows
**Date**: 2025-12-21

## Entity Relationship Diagram

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    ba_user      │       │   ba_account    │       │ refresh_tokens  │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──┐   │ id (PK)         │       │ id (PK)         │
│ email           │   │   │ user_id (FK)────┼───────│ user_id (FK)────┼───┐
│ name            │   │   │ provider_id     │       │ token_hash      │   │
│ image           │   │   │ account_id      │       │ expires_at      │   │
│ email_verified  │   │   │ password        │       │ created_at      │   │
│ created_at      │   │   │ access_token    │       │ revoked         │   │
│ updated_at      │   │   │ refresh_token   │       └─────────────────┘   │
└─────────────────┘   │   │ created_at      │                             │
        │             │   │ updated_at      │                             │
        │             │   └─────────────────┘                             │
        │             │                                                   │
        │             └───────────────────────────────────────────────────┘
        │
        │ 1:N
        ▼
┌─────────────────┐       ┌─────────────────┐
│  chat_sessions  │       │  chat_messages  │
├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────│ id (PK)         │
│ user_id (FK)────┼───────│ chat_session_id │
│ title           │       │ sender          │
│ created_at      │       │ content         │
│ last_interaction│       │ sequence_number │
│ is_active       │       │ timestamp       │
└─────────────────┘       └─────────────────┘
```

## Entities

### ba_user (Existing - No Changes)

Represents a registered user account.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | UUID generated by Better Auth |
| email | TEXT | UNIQUE, NOT NULL | User's email address |
| name | TEXT | NULLABLE | Display name |
| image | TEXT | NULLABLE | Profile image URL |
| email_verified | BOOLEAN | DEFAULT FALSE | Email verification status |
| created_at | TIMESTAMP | NOT NULL | Account creation time |
| updated_at | TIMESTAMP | NOT NULL | Last update time |

**Validation Rules**:
- Email must be valid format (RFC 5322)
- Email must be unique across all users

### ba_account (Existing - No Changes)

Represents an authentication method linked to a user.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | UUID |
| user_id | TEXT | FK → ba_user.id | Owner user |
| provider_id | TEXT | NOT NULL | 'credential' or 'google' |
| account_id | TEXT | NOT NULL | Email (credential) or Google ID |
| password | TEXT | NULLABLE | Bcrypt hash (credential only) |
| access_token | TEXT | NULLABLE | OAuth access token |
| refresh_token | TEXT | NULLABLE | OAuth refresh token |
| access_token_expires_at | TIMESTAMP | NULLABLE | OAuth expiry |
| refresh_token_expires_at | TIMESTAMP | NULLABLE | OAuth expiry |
| scope | TEXT | NULLABLE | OAuth scopes |
| created_at | TIMESTAMP | NOT NULL | Creation time |
| updated_at | TIMESTAMP | NOT NULL | Update time |

**Validation Rules**:
- password required when provider_id = 'credential'
- One account per (user_id, provider_id) combination

### refresh_tokens (New)

Stores refresh token hashes for revocation support.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Token identifier |
| user_id | TEXT | FK → ba_user.id, CASCADE DELETE | Token owner |
| token_hash | TEXT | NOT NULL | SHA-256 hash of refresh token |
| expires_at | TIMESTAMP | NOT NULL | Token expiration time |
| created_at | TIMESTAMP | DEFAULT NOW() | Token creation time |
| revoked | BOOLEAN | DEFAULT FALSE | Revocation flag |

**Validation Rules**:
- token_hash must be unique
- expires_at must be in the future when created

**Indexes**:
```sql
CREATE INDEX idx_refresh_tokens_user ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_hash ON refresh_tokens(token_hash);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at) WHERE NOT revoked;
```

### chat_sessions (Existing - No Changes)

Represents a chat conversation window.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Session identifier |
| user_id | TEXT | NOT NULL | Owner user ID |
| title | TEXT | NULLABLE | Auto-generated from first message |
| created_at | TIMESTAMP | DEFAULT NOW() | Session creation time |
| last_interaction | TIMESTAMP | DEFAULT NOW() | Last message time |
| is_active | BOOLEAN | DEFAULT TRUE | Session active status |

**Validation Rules**:
- title truncated to 50 characters if auto-generated
- last_interaction updated on every new message

**Indexes**:
```sql
CREATE INDEX idx_chat_sessions_user_last
ON chat_sessions(user_id, last_interaction DESC);
```

### chat_messages (Existing - No Changes)

Represents a single message within a chat session.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Message identifier |
| chat_session_id | UUID | FK → chat_sessions.id | Parent session |
| sender | TEXT | NOT NULL | 'user' or 'fubuni' |
| content | TEXT | NOT NULL | Message content |
| sequence_number | INTEGER | NOT NULL | Order within session |
| timestamp | TIMESTAMP | DEFAULT NOW() | Message creation time |

**Validation Rules**:
- sender must be 'user' or 'fubuni'
- sequence_number starts at 1, increments per session
- content must not be empty

**Indexes**:
```sql
CREATE INDEX idx_chat_messages_session_seq
ON chat_messages(chat_session_id, sequence_number);
```

## State Transitions

### User Account States

```
[Not Exists] ──register──► [Active]
                              │
                              ├──login──► [Authenticated Session]
                              │                    │
                              │                    └──logout/expire──► [Active]
                              │
                              └──delete──► [Not Exists]
```

### Chat Session States

```
[Not Exists] ──create/first message──► [Active]
                                          │
                                          ├──add message──► [Active] (update last_interaction)
                                          │
                                          ├──deactivate──► [Inactive]
                                          │
                                          └──delete──► [Not Exists]
```

### Refresh Token States

```
[Not Exists] ──login/register──► [Valid]
                                    │
                                    ├──use (refresh)──► [Valid] (new token)
                                    │
                                    ├──logout──► [Revoked]
                                    │
                                    └──expire──► [Expired]
```

## Cascade Delete Rules

| Parent | Child | Action |
|--------|-------|--------|
| ba_user | ba_account | CASCADE DELETE |
| ba_user | refresh_tokens | CASCADE DELETE |
| ba_user | chat_sessions | CASCADE DELETE (manual) |
| chat_sessions | chat_messages | CASCADE DELETE |

## Migration Script

```sql
-- New table for refresh token management
CREATE TABLE IF NOT EXISTS refresh_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL REFERENCES ba_user(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL UNIQUE,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  revoked BOOLEAN DEFAULT FALSE
);

-- Indexes for refresh_tokens
CREATE INDEX IF NOT EXISTS idx_refresh_tokens_user ON refresh_tokens(user_id);
CREATE INDEX IF NOT EXISTS idx_refresh_tokens_hash ON refresh_tokens(token_hash);
CREATE INDEX IF NOT EXISTS idx_refresh_tokens_expires ON refresh_tokens(expires_at) WHERE NOT revoked;

-- Index for chat_sessions user lookup
CREATE INDEX IF NOT EXISTS idx_chat_sessions_user_last
ON chat_sessions(user_id, last_interaction DESC);

-- Index for chat_messages ordering
CREATE INDEX IF NOT EXISTS idx_chat_messages_session_seq
ON chat_messages(chat_session_id, sequence_number);
```
